<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">

	<title>botsbox</title>
	<link rel="icon" href="/static/img/favicon.ico">

	<link rel="stylesheet" href="/static/css/uikit.min.css">
	<link rel="stylesheet" href="/static/css/uikit-components/notify.min.css">
	<link rel="stylesheet" href="/static/css/codemirror.css">
	<link rel="stylesheet" href="/static/css/codemirror-monokai.css">
</head>

<body>

	<div id="body-container" class="uk-height-viewport uk-clearfix">

		<div id="header">
			<div class="uk-margin-top uk-clearfix">
				<div class="uk-float-left uk-flex uk-flex-bottom">
					<img class="uk-margin-small-left" src="/static/img/favicon.ico" style="width: 24px">
					<span class="uk-margin-small-left">botsbox<small class="uk-text-muted uk-margin-small-left">{{ .version }}</small></span>
				</div>

				<div class="uk-float-right uk-margin-right">
					<span v-if="job" v-html="job.title" class="uk-margin-right"></span>
					<a href="javascript:history.back();" class="uk-icon-button uk-icon-arrow-left"></a>
					<a href="javascript:;" class="uk-icon-button uk-icon-check" @click="save()"></a>
				</div>
			</div>

			<hr style="margin-bottom: 0">
		</div>

		<div id="rule-container" class="uk-grid uk-grid-collapse">

			<div id="rule-viz" class="uk-width-1-2"></div>

			<div id="rule-editor" class="uk-width-1-2"></div>

		</div>

	</div>

	<script src="/static/js/jquery.min.js"></script>
	<script src="/static/js/vue.min.js"></script>
	<script src="/static/js/uikit.min.js"></script>
	<script src="/static/js/uikit-components/notify.min.js"></script>
	<script src="/static/js/codemirror.js"></script>
	<script src="/static/js/codemirror-javascript.js"></script>
	<script src="/static/js/d3.min.js"></script>
	<script src="/static/js/utils.js"></script>

	<script type="text/javascript">
	var h = $('#body-container').height() - $('#header').height() - $('#header').offset().top;
	$('#rule-viz').height(h);

	var vm = new Vue({

		el: '#body-container',

		data: {
			jobId: '{{ .jobId }}',

			job: null,
			fetchingJob: false,

			ruleEditor: null,
			ruleVizTimeoutId: null,

			saving: false,
		},

		computed: {

			hasJobId: function() {
				var vm = this;
				return vm.jobId && vm.jobId.length > 0;
			},

		},

		mounted: function() {
			var vm = this;

			if (vm.hasJobId) {
				vm.fetchJob(vm.jobId);
			}

			var rulePlaceholder = vm.hasJobId ? '' : `{
	"$every": "5m",
	"$entries": [
		{
			"$name": "index_page",
			"$url": "https://<your-target>"
		}
	],
	"index_page": {
		"$outputs": [
			{
				"$name": "<dataset-name>",
				"$data": {
					"title": "$title",
					"page": "$raw"
				}
			}
		]
	}
}`;

			vm.ruleEditor = CodeMirror(document.getElementById("rule-editor"), {
				value: rulePlaceholder,
				mode: {
					name: "javascript",
					json: true,
				},
				theme: 'monokai',
				lineNumbers: true,
			});

			vm.ruleEditor.setSize('100%', h);

			vm.ruleEditor.on('changes', function() {
				clearTimeout(vm.ruleVizTimeoutId);
				vm.ruleVizTimeoutId = setTimeout(function() {
					vm.viz();
				}, 300);
			});

			window.addEventListener('resize', function() {
				vm.viz();
			})

			vm.viz();
		},

		methods: {

			fetchJob: function(jobId) {
				var vm = this;

				vm.fetchingJob = true;
				$.get("/api/job/" + jobId, function(data) {
					vm.job = data;

					if (data['rule']) {
						vm.ruleEditor.setValue(data['rule']);
					}
				}, "json").always(function() {
					vm.fetchingJob = false;
				});
			},

			viz: function() {
				var vm = this;

				try {
					var rule = JSON.parse(vm.ruleEditor.getValue());
					utils.vizRule('#rule-viz', rule, $('#rule-viz').width(), $('#rule-viz').height());
				} catch (e) {
					console.error(e);
				}
			},

			save: function() {
				var vm = this;

				if (vm.saving) {
					return;
				}

				var rule = vm.ruleEditor.getValue();
				if (!rule) {
					return;
				}

				if (vm.hasJobId) {
					UIkit.modal.prompt("Update name:", (vm.job && vm.job.title) || "", function(title) {
						if (!title) {
							UIkit.notify('Name is required', { timeout: 2000, status: 'danger' });
							return;
						}

						vm.updateJob(vm.jobId, title, rule);
					});
				} else {
					UIkit.modal.prompt("Give a name:", "", function(title) {
						if (!title) {
							UIkit.notify('Name is required', { timeout: 2000, status: 'danger' });
							return;
						}

						vm.createJob(title, rule);
					});
				}
			},

			createJob: function(title, rule) {
				var vm = this;

				vm.saving = true;
				$.post("/api/createJob", {
					title: title,
					rule: rule,
				}, function(data) {
					code = data['code'];
					if (!code) {
						UIkit.modal.blockUI("Job created! Redirect after 2 sec...");
						setTimeout(function() {
							location.href = '/';
						}, 2000);
					} else {
						UIkit.notify('Save failed, please try later', { timeout: 2000, status: 'warning' });
					}
				}, "json").always(function() {
					vm.saving = false;
				});
			},

			updateJob: function(jobId, title, rule) {
				var vm = this;

				vm.saving = true;
				$.post("/api/job/" + jobId + "/update", {
					title: title,
					rule: rule,
				}, function(data) {
					code = data['code'];
					if (!code) {
						UIkit.modal.blockUI("Job updated! Redirect after 2 sec...");
						setTimeout(function() {
							location.href = '/';
						}, 2000);
					} else {
						UIkit.notify('Save failed, please try later', { timeout: 2000, status: 'warning' });
					}
				}, "json").always(function() {
					vm.saving = false;
				});
			},

		},

	});
	</script>
</body>

</html>